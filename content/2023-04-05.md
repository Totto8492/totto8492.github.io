+++
title = "Raspberry Pi Picoにピンヘッダをつけてみました"
date = "2023-04-05"
[taxonomies]
tags = ["electrical"]
+++

{{ img(src = "/images/2023-04-04_00-14-04.jpg") }}
ピンを表と裏の両方に生やしました。
なんだかムカデみたいですが、これはこれで可愛いと思います。

さあこれを開発環境からデバッグできるようにしてみましょう！

<!-- more -->
---

おしりに生えている3本のピンはSWDピンです。
ここにデバッグプローブをつないで開発環境とI/Oする経路を確保します。
一般的にラズパイPicoのデバッグプローブとして2枚目のラズパイPicoを使うケースが多いようですが、ここではちょっと趣向を凝らし、多機能型USB・シリアル変換器を用いて通信します。

FT232HというUSB・シリアル変換器にはMPSSEという機能が備わっています。
連続したビット列を比較的早口で喋ってくれます。
開発にはlibftdiライブラリを使用しますが、すでにOpenOCDがMPSSEによるSWD通信を実装してくれていたので、今回はこれを用います。

シリアル変換器にSWDのプロトコルを喋ってもらうための準備をします。

{{ img(src = "/images/2023-04-05_KiCad.png") }}

かなり端折った設計図です。これの右半分をユニバーサル基板に実装します。

{{ img(src = "/images/2023-04-04_00-11-02.jpg") }}

はい。繋げたところです。結局VBUSとリセットピンを端折りました。

FT232Hから伸びたSWDのデータ出力は抵抗器を介してデータ入力につながっています。これで半二重通信ができますね。

OpenOCDがラズパイPicoのMCUであるRP2040と正しく通信するためにはもうひと工夫必要でした。
ラズパイ公式がOpenOCDのフォークを公開しており、いくつかパッチが当てられています。
これをビルドした上で使います。

開発環境にはCode(OSS版)にCortex-Debug拡張を入れたものを使います。
STM32で遊ぶときと同じ、普段使いの環境です。

若干の試行錯誤の末、SWDを介したデバッグができるようになりました。

{{ img(src = "/images/Screenshot_20230405_001250.png") }}

どうぞ拡大してみてください。いいデバッグ画面でしょう。余裕の情報量だ。プロトコルが違いますよ。

気に入ったのは……RTT出力(画面下)だ。

ソースコード内のrprintln!マクロから自由にデバッグ出力をすることができます。
出力先は内部的にリングバッファで実装されているそうで、デフォルトではSRAMに1KiBのバッファが固定で確保されます。
このリングバッファがオーバーフローしたときの挙動は _上書き_ or _ブロッキング_ から設定できます。

今回はただのLチカ@0.5Hzなのでオーバーフローを心配する必要はないでしょう。
もし50MHzでLチカさせたいときにはちょっと気にしたほうがいいかもしれませんね。

以上でデバッグ環境が整ったので、今後はより効率よく開発できるかなと思います。
