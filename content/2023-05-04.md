+++
title = "CMSIS-DAP互換機制作"
date = "2023-05-04"
[taxonomies]
tags = ["electrical"]
+++

以前作ったシリアル変換器を利用したデバッグプローブが時折不機嫌になるので、新しく作り直してみました。

どういう構成にしたものか〜と適当に調べた結果、今回はDAP42というファームウェアを使うことにしました。STM32のF042シリーズやF103シリーズ向けのCMSIS-DAP互換のOSSファームウェアです。これを手元にあったSTM32マイコンSTM32F042K6T6に書き込んで使います。

回路等は以前秋月で購入した色物基板AE-C-DIGITALに実装しました。なかなか変わったパターンが実装済みの基板です。手元の普通のユニバーサルC基板が少なくなってきたので、その代わりに使うことにしました。

{{ img( src = "/images/2023-05-04_00-21-13.jpg" ) }}

こんな感じになりました。
とりあえず次のような用途のピンヘッダを生やしてあります。

- 3.3V
- 5V
- UART
- SWD

DAP42のおかげでCMSIS-DAP互換MCUであればとりあえず繋げることはできます。STM32もラズピコもコレ一本！って感じです。

動作はおおむね良好で、通信エラーの類は今の所発生してなさそうです（スリープビットの指定ミスによる通信途絶を除く）。

しいて言えば、USB 1.1による接続ですのでI/Oがちょっと遅いかな〜と感じました。大きめのバイナリを書き込むときなどに気になるときはあります。これについてはビルドオプションをサイズ削減優先を指定しておき、ねちっこいトラブルが起きたときにだけフルのデバッグビルドを書き込む運用をしています。

{{ img( src = "/images/2023-05-04_00-24-22.jpg" ) }}

微妙に解体できます。
